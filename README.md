# film-exif

An analog photography tool for recording and assigning metadata to scanned film images.

## Overview

Many of the modern conveniences of a digital camera are not available when using a film camera. For example, information about the photo-taking conditions are not recorded, which can be crucial in learning photography or troubleshooting an old camera. Some photographers write notes while taking photos to refer back on, but this can be confusing, especially if it is a large collection.

`film-exif` is a two-part tool that records photo conditions, and assigns Exif tags to the JPEG files scanned from film.



## Recording Conditions

When taking photos, this tool is used alongside the camera to make note of picture-taking conditions such as aperture and shutter speed. After the film is developed and scanned, an XML file can be generated for use with the second part of the tool.

Aperture is referred to by f-numbers, represented by a `double`. The standard full-stop f-number scale is listed here for reference (the XML file stores aperture multiplied by a factor of `10`):

| f-stop | XML Value (f-stop * 10) |
| :----: | :---------------------: |
|  1.4   |           14            |
|   2    |           20            |
|  2.8   |           28            |
|   4    |           40            |
|  5.6   |           56            |
|   8    |           80            |
|   11   |           110           |
|   16   |           160           |
|   22   |           220           |

Shutter speed is referred to by (fractions of) seconds, and are represented by a `double`. Common shutter speeds are listed here for convenience (XML stores the information as simply the denominator of the fraction, multiplied by a factor of 10):

| Shutter Speed | XML Value (denominator * 10) |
| :-----------: | :--------------------------: |
|    1/1000     |            10000             |
|     1/500     |             5000             |
|     1/250     |             2500             |
|     1/125     |             1250             |
|     1/60      |             600              |
|     1/30      |             300              |
|     1/15      |             150              |
|      1/8      |              80              |
|      1/4      |              40              |
|      1/2      |              20              |
|       1       |              10              |



## Exif Assignment

Using the XML file generated by the first tool, each of the JPEG files scanned from the film are assigned the corresponding Exif tags. The metadata assignment is accomplished by creating a new APP1 segment with the XML information, and inserting it into the JPEG file. There are no modifications to the rest of the file, so the only difference is the metadata.

### Usage

`./exif-assign <xml-filepath> <images-directory> <output-directory>` 

#### `<xml-filepath>`

The filepath to the XML file generated by the first part of the tool.

#### `<images-directory>`

The source JPEG files of each exposure from the roll of film are assumed to be within the same folder, as well as named similarly and sequentially. Most digital cameras and scanners save images with a prefix followed by a number, for example `DSF1234.jpg`. The specific prefix and number does not matter, only that every file has the same prefix, and the number reflects the order in which the roll of film was exposed.

#### `<output-directory>`

By default the assignment of metadata is non-destructive; `film-exif` will write new JPEG files with metadata to this directory. If desired, the source JPEG files can be overwritten instead by entering the flag `-o` for this argument.

<br><br><br>

The section below gives a brief outline on the structure of a JPEG file and shows how the replacement APP1 segment is generated.



### JPEG Structure (Simplified)

| Name                 | Hex Marker |
| -------------------- | ---------- |
| SOI (Start of Image) | 0xFFD8     |
| APPn                 | 0xFFEn     |
| ...                  |            |
| EOI (End of Image)   | 0xFFD9     |

APPn segments are application specific, and the first 2 bytes of which denote which APP segment it is. Multiple segments of the same type can exist within the same JPEG file. Exif information is stored in APP1, which appears after SOI and APP0 (if it exists). Other segments exist in the `...`, containing information such as the thumbnail information and the compressed image data. `film-exif` does not deal with them; only with APP1. 

However, there may be existing APP1 segments (and therefore existing Exif information) from scanners or software used to create the JPEG - `film-exif` will delete these since they do not reflect the photographic conditions of the film camera. Other APPn segments contain other forms of metadata, such as JFIF, ICC, FlashPix, and Photoshop's IPTC. `film-exif` will delete these segments as well.

##### APP1

| Name        | Content                                             | Hex                  | Size (Bytes) |
| ----------- | --------------------------------------------------- | -------------------- | ------------ |
| APP1 Size   | Size (including size marker, excluding APP1 marker) | 0xXXXX               | 2            |
| Exif Header | "Exif\null\null"                                    | 0x4578 0x6966 0x0000 | 6            |
| TIFF Header | "II" for little endian, "MM" for big endian         | 0x4D4D               | 2            |
|             | TIFF ID (always the same)                           | 0x002A               | 2            |
|             | Offset to 0th IFD (from TIFF Header; 8 bytes)       | 0x0000 0x0008        | 4            |

Note that `film-exif` uses big-endian, and all hex numbers are represented here as such.

Inside APP1, Image Frame Directories (IFDs) organize the information. There are a number of IFDs, but `film-exif` only uses IFD0 and the EXIF IFD, which appear in that order after the APP1 header. IFD0 is a "table of contents" for other IFDs in APP1, while EXIF IDFs contain the Exif information. IFDs have the following structure:

##### IFDs

| Name                                  | Size (Bytes)   |
| ------------------------------------- | -------------- |
| IFD Size                              | 2              |
| Directory (each field in TIFF Format) | 12 (per entry) |
| ...                                   |                |
| Next IFD Offset                       | 4              |
| IFD Data Area                         | Variable       |
| ...                                   |                |

##### TIFF Format (IFD Field Format)

| Name    | Notes                                                        | Size (Bytes) |
| ------- | ------------------------------------------------------------ | ------------ |
| Tag ID  | These are non-unique across IFDs!                            | 2            |
| Type ID | 1 - Byte<br />2 - Byte Array (ie. ASCII)<br />3 - Short (uint16)<br />4 - Long (uint32)<br />5 - Rational (2 * uint32)<br />7 - Undefined (byte array)<br />9 - SLong (int32)<br />10 - SRational (2 * int32) | 2            |
| Count   | ie. Number of components                                     | 4            |
| Value   | If value is greater than 4 bytes, this contains offset to the data in the data area (starting at the TIFF header; ie. 0x4949) | 4            |

A list of EXIF and TIFF tags can be found at https://exiftool.org/TagNames/EXIF.html

In our case, IFD0 only contains one entry in the directory: the EXIF IFD Offset. EXIF IFD lists each metadata metric that we are interested in. As an example, aperture and shutter speed are recorded as Type 5, and in the data area the 2 `uint32`'s are divided to produce the result. The XML file data is converted and populates these fields. Since the recording part of `film-exif` records a small number of metrics (compared to a digital camera), our generated APP1 segment is relatively short.

In implementation, IFD field values are set from the IFD object, since they require IFD context to be accurate. For fields with data greater than 4 bytes, the next available offset in the data area must be calculated before the field is added.

## Assumptions

- `film-exif` can only parse JPEG files.
- `film-exif` assumes that all existing metadata is a result from the scanner/software, and will delete all existing APPn segments before writing its own.



## Further Reading

Below are some sources that were used in creating `film-exif`, containing more information about the JPEG/EXIF specification:

- https://www.codeproject.com/Articles/43665/ExifLibrary-for-NET
- http://gvsoft.no-ip.org/exif/exif-explanation.html
- https://docs.fileformat.com/image/jpeg/
- https://exiftool.org/TagNames/EXIF.html
- https://www.disktuna.com/list-of-jpeg-markers/



## Potential Features

After basic functionality is completed, the following features may be considered for implementation:

- Different f-number scales (eg. half stop, third stop)
- Custom f-number scales (ie. for different lenses that have specific f-stops)
- More metadata: eg. time/date, focal length, make/model of camera, etc.